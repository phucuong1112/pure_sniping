<!DOCTYPE html>
<html>

<head>
    <title>Crab Finder</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<style>
    html,
    body {
        font-family: Tahoma;
        font-size: 16px;
        text-align: center;
        scroll-behavior: smooth;
    }

    .button {
        border-radius: 8px;
        border: none;
        background-color: #56A5E1;
        color: white;
        font-family: Tahoma;
        font-size: 13px;
        text-align: center;
        padding: 10px 15px;
        cursor: pointer;
    }

    .button:hover {
        background-color: #438cc3;
    }

    .nav {
        border: 1px solid #ccc;
        border-width: 1px 0;
        list-style: none;
        margin: 0;
        padding: 0;
        text-align: center;
    }

    .nav li {
        display: inline;
    }

    .nav a {
        display: inline-block;
        padding: 10px;
    }

    .hscroll {
        overflow-x: auto;
        /* Horizontal */
    }

    table {
        border-collapse: collapse;
        margin-left: auto;
        margin-right: auto;
    }

    td,
    th {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
    }

    tr:nth-child(even) {
        background-color: #f2f2f2;
    }

    tr:hover {
        background-color: #ddd;
    }

    th {
        padding-top: 12px;
        padding-bottom: 12px;
        background-color: #04AA6D;
        color: white;
    }

    .tab {
        overflow: hidden;
        border: 1px solid #ccc;
        background-color: #f1f1f1;
        margin-left: auto;
        margin-right: auto;
    }

    .tab button {
        background-color: inherit;
        float: center;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 14px 16px;
        transition: 0.3s;
        font-size: 17px;
    }

    .tab button:hover {
        background-color: #ddd;
    }

    .tab button.active {
        background-color: #ccc;
    }

    .tabcontent {
        display: none;
        padding: 20px 12px;
        border: 1px solid #ccc;
        border-top: none;
    }
</style>

<body onload="checkSettings();">
    <ul class="nav">
        <li><a href="https://crabada-resources.github.io/looting_statistics/">Revenue statistics</a></li>
        <li><a href="https://crabada-resources.github.io/breeding_calculator/">Breeding calculator</a></li>
    </ul>

    <div id="header">
        <h2>Crab Finder</h2>
        <br></br>

        <div class="tab">
            <button class="tablinks" onclick="openTab(event, 'quick')" id="tab_1">Quick search</button>
            <button class="tablinks" onclick="openTab(event, 'buy')" id="tab_2">Should I buy this crab?</button>
            <button class="tablinks" onclick="openTab(event, 'stats')" id="tab_3">Search by stats</button>
        </div>

        <div id="quick" class="tabcontent">
            <form id="quick_settings" onsubmit="return false">
                <input type="checkbox" id="pure" name="pure" checked>
                <label for="pure">Pure</label><br>
                <input type="checkbox" id="pure_eggs" name="pure_eggs">
                <label for="pure_eggs">Pure Eggs</label><br>
                <input type="checkbox" id="legendary" name="legendary">
                <label for="legendary">Legendary</label><br>
                <input type="checkbox" id="highbp" name="highbp">
                <label for="highbp">High BP (220+)</label><br>
                <input type="checkbox" id="highmp" name="highmp">
                <label for="highmp">High MP (77+)</label><br>
                <input type="checkbox" id="c56" name="c56">
                <label for="c56">5/6 and 6/6 non-pure</label><br>
                Max price (optional): &nbsp;&nbsp;<input type="number" id="price" step="1" style="width: 10em" /><br>
                Max breed (optional): &nbsp;&nbsp;<input type="number" id="breed" step="1"
                    style="width: 10em" /><br><br>

                <button id="calculateBtn" class="button" onclick="calculate_quick()">Find crabs!</button>
            </form>
        </div>


        <div id="stats" class="tabcontent">
            <form id="crabs_settings" onsubmit="return false">
                Min HP (optional): &nbsp;&nbsp;<input type="number" id="hp" step="1" style="width: 10em" /><br><br>
                Min Damage (optional): &nbsp;&nbsp;<input type="number" id="damage" step="1"
                    style="width: 10em" /><br><br>
                Min Armor (optional): &nbsp;&nbsp;<input type="number" id="armor" step="1"
                    style="width: 10em" /><br><br>
                Min Speed (optional): &nbsp;&nbsp;<input type="number" id="speed" step="1"
                    style="width: 10em" /><br><br>
                Min Critical (optional): &nbsp;&nbsp;<input type="number" id="critical" step="1"
                    style="width: 10em" /><br><br>
                Min BP (optional): &nbsp;&nbsp;<input type="number" id="minbp" step="1" style="width: 10em" /><br><br>
                Min MP (optional): &nbsp;&nbsp;<input type="number" id="minmp" step="1" style="width: 10em" /><br><br>
                Max price (optional): &nbsp;&nbsp;<input type="number" id="max_price" step="1"
                    style="width: 10em" /><br><br>
                Max breed (optional): &nbsp;&nbsp;<input type="number" id="max_breed" step="1"
                    style="width: 10em" /><br><br>

                <button id="calculateBtn" class="button" onclick="calculate_stats()">Find crabs!</button>
            </form>
        </div>


        <div id="buy" class="tabcontent">
            <form id="crabs_settings" onsubmit="return false">
                Crab ID: &nbsp;&nbsp; <input type="number" id="crabid" min="0" max="99999" step="1"
                    style="width: 10em" />
                <br></br>
                Price: &nbsp;&nbsp;<input type="number" id="price_buy" step="1" style="width: 10em" />
                <br></br>

                <input type="checkbox" id="sameclass" name="sameclass">
                <label for="sameclass">Compare only the same class</label><br></br>


                <button id="calculateBtn" class="button" onclick="calculate_buy()">Find out!</button>
            </form>
        </div>

        <div id="results" style="display: none">
            <h3> Results </h3>
            <p id="loading">Loading...</p>
            <div id="resuls_text"></div>
            <br>
        </div>
    </div>

</body>
<script type="text/javascript">
    function openTab(evt, cityName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(cityName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    document.getElementById("tab_1").click();

    function GetURLParameter(sParam) {
        const sPageURL = window.location.search.substring(1);
        const sURLVariables = sPageURL.split('&');
        for (let i = 0; i < sURLVariables.length; i++) {
            const sParameterName = sURLVariables[i].split('=');
            if (sParameterName[0] == sParam) {
                return sParameterName[1];
            }
        }
    }

    function checkSettings() {
        let pure = document.getElementById("pure");
        let pure_eggs = document.getElementById("pure_eggs");
        let legendary = document.getElementById("legendary");
        let highbp = document.getElementById("highbp");
        let highmp = document.getElementById("highmp");
        let c56 = document.getElementById("c56");
        let price = document.getElementById("price");
        let breed = document.getElementById("breed");


        if (localStorage.getItem("pure") == 'true') {
            pure.setAttribute("checked", localStorage.getItem("pure"));
        }
        if (localStorage.getItem("pure_eggs") == 'true') {
            pure_eggs.setAttribute("checked", localStorage.getItem("pure_eggs"));
        }

        if (localStorage.getItem("legendary") == 'true') {
            legendary.setAttribute("checked", localStorage.getItem("legendary"));
        }
        if (localStorage.getItem("highbp") == 'true') {
            highbp.setAttribute("checked", localStorage.getItem("highbp"));
        }
        if (localStorage.getItem("highmp") == 'true') {
            highmp.setAttribute("checked", localStorage.getItem("highmp"));
        }
        if (localStorage.getItem("c56") == 'true') {
            c56.setAttribute("checked", localStorage.getItem("c56"));
        }
        if (localStorage.getItem("price") != null) {
            price.setAttribute("value", localStorage.getItem("price"));
        }
        if (localStorage.getItem("breed") != null) {
            breed.setAttribute("value", localStorage.getItem("breed"));
        }

        let hp = document.getElementById("hp");
        let damage = document.getElementById("damage");
        let armor = document.getElementById("armor");
        let speed = document.getElementById("speed");
        let critical = document.getElementById("critical");
        let minbp = document.getElementById("minbp");
        let minmp = document.getElementById("minmp");
        let max_price = document.getElementById("max_price");
        let max_breed = document.getElementById("max_breed");

        if (localStorage.getItem("damage") != null) {
            damage.setAttribute("value", localStorage.getItem("damage"));
        }
        if (localStorage.getItem("hp") != null) {
            hp.setAttribute("value", localStorage.getItem("hp"));
        }
        if (localStorage.getItem("armor") != null) {
            armor.setAttribute("value", localStorage.getItem("armor"));
        }
        if (localStorage.getItem("speed") != null) {
            speed.setAttribute("value", localStorage.getItem("speed"));
        }
        if (localStorage.getItem("critical") != null) {
            critical.setAttribute("value", localStorage.getItem("critical"));
        }
        if (localStorage.getItem("minbp") != null) {
            minbp.setAttribute("value", localStorage.getItem("minbp"));
        }
        if (localStorage.getItem("minmp") != null) {
            minmp.setAttribute("value", localStorage.getItem("minmp"));
        }
        if (localStorage.getItem("max_price") != null) {
            max_price.setAttribute("value", localStorage.getItem("max_price"));
        }
        if (localStorage.getItem("max_breed") != null) {
            max_breed.setAttribute("value", localStorage.getItem("max_breed"));
        }
        
        let crabid = document.getElementById("crabid");
        let price_buy = document.getElementById("price_buy");

        let parametercrabid = GetURLParameter('crabid');
        let parameterprice = GetURLParameter('price_buy');

        let sameclass = document.getElementById("sameclass");
        let parametersameclass = GetURLParameter('sameclass');



        if (parametercrabid != null && parameterprice != null && parametersameclass != null) {
            crabid.setAttribute("value", parametercrabid);
            price_buy.setAttribute("value", parameterprice);
            document.getElementById("tab_2").click();
            if (parametersameclass == 1) {
                sameclass.setAttribute("checked", parametersameclass);
            }
            calculate_buy()
        }

    }

    const dec2hex = str => { // .toString(16) only works up to 2^53
        var dec = str.toString().split(''), sum = [], hex = [], i, s
        while (dec.length) {
            s = 1 * dec.shift()
            for (i = 0; s || i < sum.length; i++) {
                s += (sum[i] || 0) * 10
                sum[i] = s % 16
                s = (s - sum[i]) / 16
            }
        }
        while (sum.length) {
            hex.push(sum.pop().toString(16))
        }
        return hex.join('')
    }

    const lookup = value => {
        if (value <= 8) {
            return 'SURGE'
        }
        else if (value < 24) {
            return 'SUNKEN'
        }
        else if (value < 39) {
            return 'PRIME'
        }
        else if (value < 54) {
            return 'BULK'
        }
        else if (value < 69) {
            return 'CRABOID'
        }
        else if (value < 84) {
            return 'RUINED'
        }
        else if (value < 99) {
            return 'GEM'
        }
        else if (value < 114) {
            return 'ORGANIC'
        }
        else {
            console.log(value, `ERROR`)
        }
    }

    const countAlleles = (dna, className) => {
        hexString = dec2hex(dna);
        dnafixed = `0${hexString}`

        shellr1 = lookup(parseInt(dnafixed.substring(30, 32), 16)) == className;
        shellr2 = lookup(parseInt(dnafixed.substring(32, 34), 16)) == className;

        hornr1 = lookup(parseInt(dnafixed.substring(36, 38), 16)) == className;
        hornr2 = lookup(parseInt(dnafixed.substring(38, 40), 16)) == className;

        bodyr1 = lookup(parseInt(dnafixed.substring(42, 44), 16)) == className;
        bodyr2 = lookup(parseInt(dnafixed.substring(44, 46), 16)) == className;

        mouthr1 = lookup(parseInt(dnafixed.substring(48, 50), 16)) == className;
        mouthr2 = lookup(parseInt(dnafixed.substring(50, 52), 16)) == className;

        eyer1 = lookup(parseInt(dnafixed.substring(54, 56), 16)) == className;
        eyer2 = lookup(parseInt(dnafixed.substring(56, 58), 16)) == className;

        pincerr1 = lookup(parseInt(dnafixed.substring(60, 62), 16)) == className;
        pincerr2 = lookup(parseInt(dnafixed.substring(62, 64), 16)) == className;

        return +shellr1 + +shellr2 + +hornr1 + +hornr2 + +bodyr1 + +bodyr2 + +mouthr1 + +mouthr2 + +eyer1 + +eyer2 + +pincerr1 + +pincerr2

    }

    const checkLegendary = (dna) => {
        hexString = dec2hex(dna);
        dnafixed = `0${hexString}`

        shell = parseInt(dnafixed.substring(4, 6), 16) > 0;
        horn = parseInt(dnafixed.substring(6, 8), 16) > 0;
        body = parseInt(dnafixed.substring(8, 10), 16) > 0;
        mouth = parseInt(dnafixed.substring(10, 12), 16) > 0;
        eyes = parseInt(dnafixed.substring(12, 14), 16) > 0;
        pincer = parseInt(dnafixed.substring(14, 16), 16) > 0;

        return shell || horn || body || mouth || eyes || pincer
    }

    function lookup_subclass(id) {
        subclass_map = {
            1: "Emeraldo",
            2: "Crazor",
            3: "Vocrano",
            4: "Spikey",
            5: "Frozo",
            6: "Cratos",
            7: "Rubie",
            8: "Amida",
            16: "Staro",
            17: "Craken",
            18: "Crobster",
            19: "Cralmon",
            20: "Creasure",
            21: "Crucket",
            22: "Crele",
            23: "Crotopus",
            31: "Bitcoin",
            32: "Cardano",
            33: "Near",
            34: "Ether",
            35: "Cz",
            36: "Fantom",
            37: "Avalanche",
            38: "Solana",
            46: "Cragma",
            47: "C-Rex",
            48: "Charoite",
            49: "Rocco",
            50: "Chief",
            51: "Cropion",
            52: "Crazurite",
            53: "Crava",
            61: "Twinner",
            62: "Onepunch",
            63: "Cropter",
            64: "Plasma",
            65: "Lasery",
            66: "Redeye",
            67: "Crocket",
            68: "Gear",
            76: "Skul",
            77: "Cragon",
            78: "Crombie",
            79: "Deadeye",
            80: "Cranosis",
            81: "Crailer",
            82: "Camun-Ra",
            83: "Crauldron",
            91: "Pearlio",
            92: "Lapidari",
            93: "Paraiba",
            94: "Cramethyst",
            95: "Cranet",
            96: "Croyo",
            97: "Earl Cray",
            98: "Magnifiso",
            106: "Natura",
            107: "Freshie",
            108: "Adam",
            109: "Eva",
            110: "Bulbie",
            111: "Celon",
            112: "Cranana",
            113: "Crawberry"
        }

        return subclass_map[id]
    }

    function calculate_buy() {
        clearForm()
        let crabid = document.getElementById("crabid").value;
        let price = document.getElementById("price_buy").value;
        let sameclass = document.getElementById("sameclass").checked;
        let loading = document.getElementById("loading");

        let results = document.getElementById("results");
        results.style.display = "block";

        const highbp_crabs = []
        const highmp_crabs = []
        const parts_crabs = []

        requests = []
        requests.push(fetch(`https://api.crabada.com/public/crabada/info/${crabid}`).then(response => response.json()))
        requests.push(fetch(`https://api.crabada.com/public/crabada/selling?limit=1000&stage=1&orderBy=price&order=asc`).then(response => response.json()))

        Promise.all(requests)
            .then(function (responses) {
                testcrab = responses[0]["result"]
                testcrab.combat = testcrab.hp + testcrab.damage + testcrab.armor
                testcrab.mine = testcrab.speed + testcrab.critical
                testcrab.price = price
                testcrab.origin = testcrab.is_origin == 1 ? 'Yes' : 'No'
                testcrab.pure_parts = +(testcrab.class_id == testcrab.horn_class) + +(testcrab.class_id == testcrab.shell_class) + +(testcrab.class_id == testcrab.body_class) + +(testcrab.class_id == testcrab.mouth_class) + +(testcrab.class_id == testcrab.eyes_class) + +(testcrab.class_id == testcrab.pincers_class)
                testcrab.alleles = countAlleles(testcrab.dna, testcrab.class_name)
                testcrab.url = `<a href="https://marketplace.crabada.com/crabada/${testcrab.crabada_id}" target="_blank" rel="noopener noreferrer">${testcrab.crabada_id}</a>`
                testcrab.dnaurl = `<a href="https://crabada-resources.github.io/breeding_calculator?crabid=${testcrab.crabada_id}" target="_blank" rel="noopener noreferrer">Link</a>`
                testcrab.subclass_name = lookup_subclass(testcrab.crabada_subclass)

                crabs = responses[1]["result"]["data"];
                crabs.forEach(c => {
                    aux = {}
                    aux.crabada_id = c.crabada_id
                    aux.class_name = c.class_name
                    aux.breed_count = c.breed_count
                    aux.combat = c.hp + c.damage + c.armor
                    aux.mine = c.speed + c.critical
                    aux.price = Math.round(c.price / 1.0e18)
                    aux.origin = c.is_origin == 1 ? 'Yes' : 'No'
                    aux.pure_parts = +(c.class_id == c.horn_class) + +(c.class_id == c.shell_class) + +(c.class_id == c.body_class) + +(c.class_id == c.mouth_class) + +(c.class_id == c.eyes_class) + +(c.class_id == c.pincers_class)
                    aux.alleles = countAlleles(c.dna, c.class_name)
                    aux.url = `<a href="https://marketplace.crabada.com/crabada/${c.crabada_id}" target="_blank" rel="noopener noreferrer">${c.crabada_id}</a>`
                    aux.dnaurl = `<a href="https://crabada-resources.github.io/breeding_calculator?crabid=${c.crabada_id}" target="_blank" rel="noopener noreferrer">Link</a>`
                    aux.subclass_name = lookup_subclass(aux.crabada_subclass)

                    if (!sameclass || (sameclass && aux.class_name == testcrab.class_name)) {
                        if (aux.combat >= testcrab.combat && aux.price < testcrab.price) {
                            highbp_crabs.push(aux)
                        }
                        if (aux.mine >= testcrab.mine && aux.price < testcrab.price) {
                            highmp_crabs.push(aux)
                        }
                        if (aux.pure_parts >= testcrab.pure_parts && aux.price < testcrab.price) {
                            parts_crabs.push(aux)
                        }
                    }
                })

                loading.innerHTML = "";

                let resuls_text = document.getElementById("resuls_text");
                resuls_text.innerHTML = ''

                resuls_text.innerHTML += "<h4>Selected crab stats:</h4>"
                let table = ''
                table += `<table><thead><tr><th>Price (TUS)</th><th>Class</th><th>Subclass</th><th>BP</th><th>MP</th><th>Breed count</th><th>Is origin?</th><th>Pure parts</th><th>Pure R Alleles</th><th>Crab ID</th><th>DNA</th></tr></thead><tbody>`
                table += `<tr><td>${testcrab.price}</td><td>${testcrab.class_name}</td><td>${testcrab.subclass_name}</td><td>${testcrab.combat}</td><td>${testcrab.mine}</td><td>${testcrab.breed_count}</td><td>${testcrab.origin}</td><td>${testcrab.pure_parts}</td><td>${testcrab.alleles}</td><td>${testcrab.url}</td><td>${testcrab.dnaurl}</td></tr>`
                table += "</tbody></table></br>"
                resuls_text.innerHTML += table


                resuls_text.innerHTML += "<h4>Crabs with higher/same BP and cheaper: " + highbp_crabs.length + "</h4>"
                if (highbp_crabs.length > 0) {
                    let table = ''
                    table += `<table><thead><tr><th>Price (TUS)</th><th>Class</th><th>Subclass</th><th>BP</th><th>MP</th><th>Breed count</th><th>Is origin?</th><th>Pure parts</th><th>Pure R Alleles</th><th>Crab ID</th><th>DNA</th></th></thead><tbody>`
                    highbp_crabs.forEach(c => {
                        table += `<tr><td>${c.price}</td><td>${c.class_name}</td><td>${c.subclass_name}</td><td>${c.combat}</td><td>${c.mine}</td><td>${c.breed_count}</td><td>${c.origin}</td><td>${c.pure_parts}</td><td>${c.alleles}</td><td>${c.url}</td><td>${c.dnaurl}</td></tr>`
                    })
                    table += "</tbody></table></br>"
                    resuls_text.innerHTML += table
                } else {
                    resuls_text.innerHTML += "None found!"
                }
                resuls_text.innerHTML += "<h4>Crabs with higher/same MP and cheaper: " + highmp_crabs.length + "</h4>"
                if (highmp_crabs.length > 0) {
                    let table = ''
                    table += `<table><thead><tr><th>Price (TUS)</th><th>Class</th><th>Subclass</th><th>BP</th><th>MP</th><th>Breed count</th><th>Is origin?</th><th>Pure parts</th><th>Pure R Alleles</th><th>Crab ID</th><th>DNA</th></th></thead><tbody>`
                    highmp_crabs.forEach(c => {
                        table += `<tr><td>${c.price}</td><td>${c.class_name}</td><td>${c.subclass_name}</td><td>${c.combat}</td><td>${c.mine}</td><td>${c.breed_count}</td><td>${c.origin}</td><td>${c.pure_parts}</td><td>${c.alleles}</td><td>${c.url}</td><td>${c.dnaurl}</td></tr>`
                    })
                    table += "</tbody></table></br>"
                    resuls_text.innerHTML += table
                } else {
                    resuls_text.innerHTML += "None found!"
                }
                resuls_text.innerHTML += "<h4>Crabs with more/same pure parts and cheaper: " + parts_crabs.length + "</h4>"
                if (parts_crabs.length > 0) {
                    let table = ''
                    table += `<table><thead><tr><th>Price (TUS)</th><th>Class</th><th>Subclass</th><th>BP</th><th>MP</th><th>Breed count</th><th>Is origin?</th><th>Pure parts</th><th>Pure R Alleles</th><th>Crab ID</th><th>DNA</th></th></thead><tbody>`
                    parts_crabs.forEach(c => {
                        table += `<tr><td>${c.price}</td><td>${c.class_name}</td><td>${c.subclass_name}</td><td>${c.combat}</td><td>${c.mine}</td><td>${c.breed_count}</td><td>${c.origin}</td><td>${c.pure_parts}</td><td>${c.alleles}</td><td>${c.url}</td><td>${c.dnaurl}</td></tr>`
                    })
                    table += "</tbody></table></br>"
                    resuls_text.innerHTML += table
                } else {
                    resuls_text.innerHTML += "None found!"
                }



            }).catch(function (error) {
                console.log(error);
            });
    }

    function calculate_quick() {
        clearForm()
        let loading = document.getElementById("loading");

        let results = document.getElementById("results");
        results.style.display = "block";

        let pure = document.getElementById("pure").checked;
        let pure_eggs = document.getElementById("pure_eggs").checked;
        let legendary = document.getElementById("legendary").checked;
        let highbp = document.getElementById("highbp").checked;
        let highmp = document.getElementById("highmp").checked;
        let c56 = document.getElementById("c56").checked;

        let price = document.getElementById("price").value;
        let breed = document.getElementById("breed").value;

        localStorage.setItem("pure", pure);
        localStorage.setItem("pure_eggs", pure_eggs);
        localStorage.setItem("legendary", legendary);
        localStorage.setItem("highbp", highbp);
        localStorage.setItem("highmp", highmp);
        localStorage.setItem("c56", c56);
        localStorage.setItem("price", price);
        localStorage.setItem("breed", breed);


        const pure_crabs = []
        const eggs_list = []
        const pure_eggs_list = []
        const legendary_crabs = []
        const highbp_crabs = []
        const highmp_crabs = []
        const c56_crabs = []

        fetch(`https://api.crabada.com/public/crabada/selling?limit=2000&orderBy=price&order=asc`).then(response => response.json())
            .then(function (response) {
                crabs = response["result"]["data"];
                crabs.forEach(c => {
                    aux = {}
                    aux.price = Math.round(c.price / 1.0e18)
                    if (price && aux.price >= price) {
                        return
                    }
                    aux.crabada_id = c.crabada_id
                    aux.url = `<a href="https://marketplace.crabada.com/crabada/${c.crabada_id}" target="_blank" rel="noopener noreferrer">${c.crabada_id}</a>`

                    if (c.stage == 1) {
                        aux.breed_count = c.breed_count

                        if (breed != '' && +aux.breed_count > +breed) {
                            return
                        }

                        aux.class_name = c.class_name
                        aux.combat = c.hp + c.damage + c.armor
                        aux.mine = c.speed + c.critical
                        aux.origin = c.is_origin == 1 ? 'Yes' : 'No'
                        aux.subclass_name = lookup_subclass(c.crabada_subclass)
                        aux.pure_parts = +(c.class_id == c.horn_class) + +(c.class_id == c.shell_class) + +(c.class_id == c.body_class) + +(c.class_id == c.mouth_class) + +(c.class_id == c.eyes_class) + +(c.class_id == c.pincers_class)
                        aux.alleles = countAlleles(c.dna, c.class_name)
                        aux.dnaurl = `<a href="https://crabada-resources.github.io/breeding_calculator?crabid=${c.crabada_id}" target="_blank" rel="noopener noreferrer">Link</a>`
                        if (aux.pure_parts == 6 && pure && aux.alleles == 12) {
                            pure_crabs.push(aux)
                        }
                        if (legendary && checkLegendary(c.dna)) {
                            legendary_crabs.push(aux)
                        }
                        if (aux.combat >= 220 && highbp) {
                            highbp_crabs.push(aux)
                        }
                        if (aux.mine >= 77 && highmp) {
                            highmp_crabs.push(aux)
                        }
                        if (c56 && (aux.pure_parts == 5 || (aux.pure_parts == 6 && aux.alleles < 12))) {
                            c56_crabs.push(aux)
                        }

                    } else {
                        if (pure_eggs) {
                            aux.dnaurl = `<a href="https://crabada-resources.github.io/breeding_calculator?eggid=${c.crabada_id}" target="_blank" rel="noopener noreferrer">Link</a>`
                            eggs_list.push(aux)
                        }
                    }
                })
                const requests = []
                eggs_list.forEach(e => {
                    requests.push(fetch(`https://api.crabada.com/public/crabada/family/${e.crabada_id}`).then(response => response.json()))
                })
                let count = -1
                Promise.all(requests)
                    .then(function (responses) {
                        responses.forEach(r => {
                            count += 1
                            const parent1 = r["result"]["crabada_parents"][0]
                            const parent2 = r["result"]["crabada_parents"][1]
                            if (parent1.class_name != parent2.class_name) {
                                return
                            }
                            if (parent1.pure_number != 6 || parent2.pure_number != 6) {
                                return
                            }

                            parent1.alleles = countAlleles(parent1.dna, parent1.class_name)
                            parent2.alleles = countAlleles(parent2.dna, parent2.class_name)
                            if (parent1.alleles != 12 || parent2.alleles != 12) {
                                return
                            }
                            let aux = eggs_list[count]
                            aux.class_name = parent1.class_name
                            pure_eggs_list.push(aux)
                        })


                        loading.innerHTML = "";

                        let resuls_text = document.getElementById("resuls_text");
                        resuls_text.innerHTML = ''

                        if (pure) {
                            resuls_text.innerHTML += "<h4>Pure crabs in the market: " + pure_crabs.length + "</h4>"
                            if (pure_crabs.length > 0) {
                                let table = ''
                                table += `<table><thead><tr><th>Price (TUS)</th><th>Class</th><th>Subclass</th><th>BP</th><th>MP</th><th>Breed count</th><th>Is origin?</th><th>Pure parts</th><th>Pure R Alleles</th><th>Crab ID</th><th>DNA</th></tr></thead><tbody>`
                                pure_crabs.forEach(c => {
                                    table += `<tr><td>${c.price}</td><td>${c.class_name}</td><td>${c.subclass_name}</td><td>${c.combat}</td><td>${c.mine}</td><td>${c.breed_count}</td><td>${c.origin}</td><td>${c.pure_parts}</td><td>${c.alleles}</td><td>${c.url}</td><td>${c.dnaurl}</td></tr>`
                                })
                                table += "</tbody></table></br>"
                                resuls_text.innerHTML += table

                            } else {
                                resuls_text.innerHTML += `None found!`
                            }

                        }

                        if (pure_eggs) {
                            resuls_text.innerHTML += "<h4>Pure crabs eggs in the market: " + pure_eggs_list.length + "</h4>"
                            if (pure_eggs_list.length > 0) {
                                let table = ''
                                table += `<table><thead><tr><th>Price (TUS)</th><th>Class</th><th>Crab ID</th><th>DNA</th></tr></thead><tbody>`
                                pure_eggs_list.forEach(c => {
                                    table += `<tr><td>${c.price}</td><td>${c.class_name}</td><td>${c.url}</td><td>${c.dnaurl}</td></tr>`
                                })
                                table += "</tbody></table></br>"
                                resuls_text.innerHTML += table

                            } else {
                                resuls_text.innerHTML += `None found!`
                            }

                        }
                        if (legendary) {
                            resuls_text.innerHTML += "<h4>Legendary crabs in the market: " + legendary_crabs.length + "</h4>"
                            if (legendary_crabs.length > 0) {
                                let table = ''
                                table += `<table><thead><tr><th>Price (TUS)</th><th>Class</th><th>Subclass</th><th>BP</th><th>MP</th><th>Breed count</th><th>Is origin?</th><th>Pure parts</th><th>Pure R Alleles</th><th>Crab ID</th><th>DNA</th></tr></thead><tbody>`
                                legendary_crabs.forEach(c => {
                                    table += `<tr><td>${c.price}</td><td>${c.class_name}</td><td>${c.subclass_name}</td><td>${c.combat}</td><td>${c.mine}</td><td>${c.breed_count}</td><td>${c.origin}</td><td>${c.pure_parts}</td><td>${c.alleles}</td><td>${c.url}</td><td>${c.dnaurl}</td></tr>`
                                })
                                table += "</tbody></table></br>"
                                resuls_text.innerHTML += table
                            } else {
                                resuls_text.innerHTML += `None found!`
                            }
                        }
                        if (highbp) {
                            resuls_text.innerHTML += "<h4>High BP crabs in the market: " + highbp_crabs.length + "</h4>"
                            if (highbp_crabs.length > 0) {
                                let table = ''
                                table += `<table><thead><tr><th>Price (TUS)</th><th>Class</th><th>Subclass</th><th>BP</th><th>MP</th><th>Breed count</th><th>Is origin?</th><th>Pure parts</th><th>Pure R Alleles</th><th>Crab ID</th><th>DNA</th></tr></thead><tbody>`
                                highbp_crabs.forEach(c => {
                                    table += `<tr><td>${c.price}</td><td>${c.class_name}</td><td>${c.subclass_name}</td><td>${c.combat}</td><td>${c.mine}</td><td>${c.breed_count}</td><td>${c.origin}</td><td>${c.pure_parts}</td><td>${c.alleles}</td><td>${c.url}</td><td>${c.dnaurl}</td></tr>`
                                })
                                table += "</tbody></table></br>"
                                resuls_text.innerHTML += table
                            } else {
                                resuls_text.innerHTML += `None found!`
                            }
                        }

                        if (highmp) {
                            resuls_text.innerHTML += "<h4>High MP crabs in the market: " + highmp_crabs.length + "</h4>"
                            if (highmp_crabs.length > 0) {
                                let table = ''
                                table += `<table><thead><tr><th>Price (TUS)</th><th>Class</th><th>Subclass</th><th>BP</th><th>MP</th><th>Breed count</th><th>Is origin?</th><th>Pure parts</th><th>Pure R Alleles</th><th>Crab ID</th><th>DNA</th></tr></thead><tbody>`
                                highmp_crabs.forEach(c => {
                                    table += `<tr><td>${c.price}</td><td>${c.class_name}</td><td>${c.subclass_name}</td><td>${c.combat}</td><td>${c.mine}</td><td>${c.breed_count}</td><td>${c.origin}</td><td>${c.pure_parts}</td><td>${c.alleles}</td><td>${c.url}</td><td>${c.dnaurl}</td></tr>`
                                })
                                table += "</tbody></table></br>"
                                resuls_text.innerHTML += table
                            } else {
                                resuls_text.innerHTML += `None found!`
                            }
                        }
                        if (c56) {
                            resuls_text.innerHTML += "<h4>5/6 or 6/6 non-pure crabs in the market: " + c56_crabs.length + "</h4>"
                            if (c56_crabs.length > 0) {
                                let table = ''
                                table += `<table><thead><tr><th>Price (TUS)</th><th>Class</th><th>Subclass</th><th>BP</th><th>MP</th><th>Breed count</th><th>Is origin?</th><th>Pure parts</th><th>Pure R Alleles</th><th>Crab ID</th><th>DNA</th></tr></thead><tbody>`
                                c56_crabs.forEach(c => {
                                    table += `<tr><td>${c.price}</td><td>${c.class_name}</td><td>${c.subclass_name}</td><td>${c.combat}</td><td>${c.mine}</td><td>${c.breed_count}</td><td>${c.origin}</td><td>${c.pure_parts}</td><td>${c.alleles}</td><td>${c.url}</td><td>${c.dnaurl}</td></tr>`
                                })
                                table += "</tbody></table></br>"
                                resuls_text.innerHTML += table
                            } else {
                                resuls_text.innerHTML += `None found!`
                            }
                        }
                    }).catch(function (error) {
                        console.log(error);
                    });
            }).catch(function (error) {
                console.log(error);
            });
    }

    function calculate_stats() {
        clearForm()
        let loading = document.getElementById("loading");

        let results = document.getElementById("results");
        results.style.display = "block";

        let hp = document.getElementById("hp").value;
        let damage = document.getElementById("damage").value;
        let armor = document.getElementById("armor").value;
        let speed = document.getElementById("speed").value;
        let critical = document.getElementById("critical").value;
        let minbp = document.getElementById("minbp").value;
        let minmp = document.getElementById("minmp").value;
        let max_price = document.getElementById("max_price").value;
        let max_breed = document.getElementById("max_breed").value;

        localStorage.setItem("hp", hp);
        localStorage.setItem("damage", damage);
        localStorage.setItem("armor", armor);
        localStorage.setItem("speed", speed);
        localStorage.setItem("critical", critical);
        localStorage.setItem("minbp", minbp);
        localStorage.setItem("minmp", minmp);
        localStorage.setItem("max_price", max_price);
        localStorage.setItem("max_breed", max_breed);

        const crabs_fixed = {}
        crabs_fixed['RUINED'] = []
        crabs_fixed['SUNKEN'] = []
        crabs_fixed['SURGE'] = []
        crabs_fixed['BULK'] = []
        crabs_fixed['PRIME'] = []
        crabs_fixed['GEM'] = []
        crabs_fixed['CRABOID'] = []
        crabs_fixed['ORGANIC'] = []

        fetch(`https://api.crabada.com/public/crabada/selling?limit=2000&stage=1&orderBy=price&order=asc`).then(response => response.json())
            .then(function (response) {
                crabs = response["result"]["data"];
                crabs.forEach(c => {
                    aux = {}
                    aux.combat = c.hp + c.damage + c.armor
                    aux.mine = c.speed + c.critical
                    aux.price = Math.round(c.price / 1.0e18)
                    aux.breed_count = c.breed_count

                    if (hp && c.hp < hp) {
                        return
                    }
                    if (damage && c.damage < damage) {
                        return
                    }
                    if (armor && c.armor < armor) {
                        return
                    }
                    if (speed && c.speed < speed) {
                        return
                    }
                    if (critical && c.critical < critical) {
                        return
                    }
                    if (minbp && aux.combat < minbp) {
                        return
                    }
                    if (minmp && aux.mine < minmp) {
                        return
                    }
                    if (max_price && aux.price > max_price) {
                        return
                    }
                    if (max_breed && aux.breed_count > max_breed) {
                        return
                    }
                
                    aux.crabada_id = c.crabada_id
                    aux.class_name = c.class_name
                    aux.subclass_name = lookup_subclass(c.crabada_subclass)
                    aux.hp = c.hp
                    aux.damage = c.damage
                    aux.armor = c.armor
                    aux.speed = c.speed
                    aux.critical = c.critical
                    aux.url = `<a href="https://marketplace.crabada.com/crabada/${c.crabada_id}" target="_blank" rel="noopener noreferrer">${c.crabada_id}</a>`
                    aux.dnaurl = `<a href="https://crabada-resources.github.io/breeding_calculator?crabid=${c.crabada_id}" target="_blank" rel="noopener noreferrer">Link</a>`

                    crabs_fixed[aux.class_name].push(aux)
                })
                loading.innerHTML = "";

                let resuls_text = document.getElementById("resuls_text");
                resuls_text.innerHTML = ''

                for (const crabclass in crabs_fixed) {
                    resuls_text.innerHTML += `<h4>${crabclass}</h4>`
                    if (crabs_fixed[crabclass].length > 0) {
                        let table = ''
                        table += `<table><thead><tr><th>Price (TUS)</th><th>Subclass</th><th>HP</th><th>Damage</th><th>Armor</th><th>Speed</th><th>Critical</th><th>BP</th><th>MP</th><th>Breed count</th><th>Crab ID</th><th>DNA</th></tr></thead><tbody>`
                        crabs_fixed[crabclass].forEach(c => {
                            table += `<tr><td>${c.price}</td><td>${c.subclass_name}</td><td>${c.hp}</td><td>${c.damage}</td><td>${c.armor}</td><td>${c.speed}</td><td>${c.critical}</td><td>${c.combat}</td><td>${c.mine}</td><td>${c.breed_count}</td><td>${c.url}</td><td>${c.dnaurl}</td></tr>`
                        })
                        table += "</tbody></table></br>"
                        resuls_text.innerHTML += table

                    } else {
                        resuls_text.innerHTML += `None found!`
                    }
                }





            }).catch(function (error) {
                console.log(error);
            });
    }

    function clearForm() {
        let resuls_text = document.getElementById("resuls_text");
        let results = document.getElementById("results");

        resuls_text.innerHTML = "";
        results.style.display = "none";

        let loading = document.getElementById("loading");
        loading.innerHTML = "Loading...";
    }


</script>

</html>